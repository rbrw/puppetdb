#!/usr/bin/env bash

set -euo pipefail

script_home="$(cd "$(dirname "$0")" && pwd)"
top="$script_home/../.."
cd "$top"  # Always run from the top level of the tree

if test -z "$(type -t bundler)"; then
    cat 2>&1 <<-EOS
	Ruby bundler does not appear to be available.
	Please install it via "gem install --user-install bundler" or similar.
	EOS
    exit 2
fi

set -x

export PUPPETSERVER_HEAP_SIZE=1G

PDB_NO_PUPPETSERVER_INSTALL="${PDB_NO_PUPPETSERVER_INSTALL:-}"
PUPPET_VERSION="${PUPPET_VERSION:-master}"
PUPPETSERVER_VERSION="${PUPPETSERVER_VERSION:-master}"

lein-pprint() {
    lein with-profile dev,ci pprint "$@" | sed -e 's/^"//' -e 's/"$//'
}

if test -d puppetserver; then
   git -C puppetserver checkout "$PUPPETSERVER_VERSION"
   git -C puppetserver clean -fdx
else
   git clone --depth 10 -b "$PUPPETSERVER_VERSION" https://github.com/puppetlabs/puppetserver
fi

(cd puppetserver
 if test -z "$PDB_NO_PUPPETSERVER_INSTALL"; then
     lein install
 fi
 dep_ver="$(lein-pprint :version)"
 mkdir -p "$top/ext/test-conf"
 echo "$dep_ver" > "$top/ext/test-conf/puppetserver-dep")

bundle install --without acceptance --path vendor/bundle
lein install-gems

# Symlink vendor/puppet to the git tree bundler checked out.  Use a
# relative path so that moving the pdb tree around won't break things.
cd vendor
puppet_path="$(bundle show puppet)"
ln -srf "$puppet_path" puppet
